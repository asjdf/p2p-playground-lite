# Security Guide

æœ¬æ–‡æ¡£è¯´æ˜ P2P Playground Lite çš„å®‰å…¨åŠŸèƒ½åŠä½¿ç”¨æ–¹æ³•ã€‚

## æ¦‚è¿°

P2P Playground Lite å®ç°äº†ä»¥ä¸‹å®‰å…¨æœºåˆ¶ï¼š

1. **PSK ç½‘ç»œè®¤è¯** - âœ… ä½¿ç”¨é¢„å…±äº«å¯†é’¥åˆ›å»ºç§æœ‰ P2P ç½‘ç»œï¼Œåªæœ‰æŒæœ‰ç›¸åŒ PSK çš„èŠ‚ç‚¹æ‰èƒ½åŠ å…¥
2. **TLS 1.3 ä¼ è¾“åŠ å¯†** - âœ… æ‰€æœ‰ P2P è¿æ¥ä½¿ç”¨ TLS 1.3 æˆ– Noise åè®®åŠ å¯†ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨
3. **åº”ç”¨åŒ…ç­¾åéªŒè¯** - ä½¿ç”¨ Ed25519 æ•°å­—ç­¾åç¡®ä¿åº”ç”¨åŒ…æ¥æºå¯ä¿¡å’Œå®Œæ•´æ€§
4. **é»˜è®¤å¼ºåˆ¶ç­¾åç­–ç•¥** - âš ï¸ **é»˜è®¤æ‹’ç»æœªç­¾ååŒ…**ï¼ˆå¯é…ç½®ä¸ºå…è®¸ï¼‰
5. **å¤šå¯†é’¥ä¿¡ä»»æ¨¡å‹** - æ”¯æŒå¤šä¸ªå¯ä¿¡å…¬é’¥ï¼Œä¾¿äºå¯†é’¥è½®æ¢å’Œå¤šå›¢é˜Ÿéƒ¨ç½²

**âš ï¸ é‡è¦å˜æ›´ï¼ˆ2026-01-19ï¼‰**ï¼š
- ä»æ­¤ç‰ˆæœ¬å¼€å§‹ï¼Œ**é»˜è®¤è¦æ±‚æ‰€æœ‰åº”ç”¨åŒ…å¿…é¡»ç­¾å**
- æœªç­¾åçš„åŒ…å°†è¢«æ‹’ç»éƒ¨ç½²
- å¼€å‘/æµ‹è¯•ç¯å¢ƒå¯é€šè¿‡é…ç½®æ˜¾å¼å…³é—­æ­¤é™åˆ¶

## åº”ç”¨åŒ…ç­¾å

### å¯†é’¥ç”Ÿæˆ

é¦–å…ˆåœ¨ controller ç«¯ç”Ÿæˆå¯†é’¥å¯¹ï¼š

```bash
# ç”Ÿæˆå¯†é’¥å¯¹ï¼ˆé»˜è®¤ä¿å­˜åˆ° ~/.p2p-playground/keys/ï¼‰
controller keygen

# æŒ‡å®šè¾“å‡ºç›®å½•
controller keygen -o /path/to/keys
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
Generating Ed25519 key pair...

âœ“ Key pair generated successfully!
  Private key: /path/to/keys/controller.key
  Public key:  /path/to/keys/controller.pub

âš ï¸  Keep the private key secure and never share it.
ğŸ“¤ Distribute the public key to nodes for signature verification.

Public key (hex): 58231049e8615ab913ce3671f75c7141a9e4759682cfa2b8148e2eb5422d6965
```

**é‡è¦**ï¼š
- ç§é’¥ (`controller.key`) å¿…é¡»å¦¥å–„ä¿ç®¡ï¼Œä¸èƒ½æ³„éœ²
- å…¬é’¥ (`controller.pub`) éœ€è¦åˆ†å‘åˆ°æ‰€æœ‰ daemon èŠ‚ç‚¹

### ç­¾ååº”ç”¨åŒ…

åœ¨éƒ¨ç½²å‰å¯¹åº”ç”¨åŒ…è¿›è¡Œç­¾åï¼š

```bash
# ç­¾ååº”ç”¨åŒ…
controller sign myapp-1.0.0.tar.gz

# ä½¿ç”¨æŒ‡å®šçš„ç§é’¥
controller sign myapp-1.0.0.tar.gz --key /path/to/controller.key
```

è¿™ä¼šç”Ÿæˆç­¾åæ–‡ä»¶ `myapp-1.0.0.tar.gz.sig`ã€‚

è¾“å‡ºç¤ºä¾‹ï¼š
```
Signing package: myapp-1.0.0.tar.gz

âœ“ Package signed successfully!
  Signature: myapp-1.0.0.tar.gz.sig
  Signature (hex): 3a7b2c...

You can now deploy this package with signature verification.
```

### éƒ¨ç½²ç­¾ååŒ…

éƒ¨ç½²æ—¶ï¼Œcontroller ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒ…å«ç­¾åæ–‡ä»¶ï¼š

```bash
# deploy å‘½ä»¤è‡ªåŠ¨æŸ¥æ‰¾ .sig æ–‡ä»¶
controller deploy myapp-1.0.0.tar.gz
```

å¦‚æœå­˜åœ¨ `myapp-1.0.0.tar.gz.sig`ï¼Œç­¾åä¼šè‡ªåŠ¨åŒ…å«åœ¨éƒ¨ç½²è¯·æ±‚ä¸­ã€‚

## PSK ç½‘ç»œè®¤è¯

### æ¦‚è¿°

PSK (Pre-Shared Key) æ˜¯ä¸€ç§ç½‘ç»œçº§åˆ«çš„è®¤è¯æœºåˆ¶ï¼Œç”¨äºåˆ›å»ºç§æœ‰ P2P ç½‘ç»œã€‚åªæœ‰æŒæœ‰ç›¸åŒ PSK çš„èŠ‚ç‚¹æ‰èƒ½ç›¸äº’è¿æ¥å’Œé€šä¿¡ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- **å¼€å‘ç¯å¢ƒ** - éš”ç¦»å¼€å‘ç½‘ç»œï¼Œé¿å…ä¸æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒæ··æ·†
- **æµ‹è¯•ç¯å¢ƒ** - åˆ›å»ºä¸“ç”¨æµ‹è¯•ç½‘ç»œ
- **ç”Ÿäº§ç¯å¢ƒ** - ç¡®ä¿åªæœ‰æˆæƒèŠ‚ç‚¹èƒ½åŠ å…¥ç”Ÿäº§ç½‘ç»œ
- **å¤šç§Ÿæˆ·** - ä¸ºä¸åŒå®¢æˆ·åˆ›å»ºéš”ç¦»çš„ P2P ç½‘ç»œ

### ç”Ÿæˆ PSK

ä½¿ç”¨ controller å‘½ä»¤ç”Ÿæˆ PSKï¼š

```bash
# ç”Ÿæˆ PSKï¼ˆé»˜è®¤ä¿å­˜åˆ° ~/.p2p-playground/pskï¼‰
controller psk

# æŒ‡å®šè¾“å‡ºè·¯å¾„
controller psk --output /path/to/psk
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
Generating pre-shared key...

âœ“ PSK generated successfully!
  File: /Users/atom/.p2p-playground/psk

âš ï¸  Keep this key secure and never share it publicly.
ğŸ“¤ Distribute this key to all nodes that should join your network.

PSK (hex): a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456

To use this PSK, add the following to your configuration:

  security:
    enable_auth: true
    psk: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
```

**é‡è¦**ï¼š
- PSK æ˜¯ 32 å­—èŠ‚ï¼ˆ256 ä½ï¼‰çš„éšæœºå¯†é’¥
- PSK ä»¥åå…­è¿›åˆ¶æ ¼å¼ï¼ˆ64 ä¸ªå­—ç¬¦ï¼‰å­˜å‚¨å’Œä¼ è¾“
- æ‰€æœ‰éœ€è¦é€šä¿¡çš„èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ PSK
- å¦¥å–„ä¿ç®¡ PSKï¼Œå°±åƒä¿ç®¡å¯†ç ä¸€æ ·

### é…ç½® PSK è®¤è¯

#### Controller é…ç½®

åœ¨ `~/.p2p-playground/controller.yaml` ä¸­é…ç½®ï¼š

```yaml
security:
  enable_auth: true  # å¯ç”¨ PSK è®¤è¯
  psk: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
```

#### Daemon é…ç½®

åœ¨ daemon é…ç½®æ–‡ä»¶ä¸­é…ç½®ç›¸åŒçš„ PSKï¼š

```yaml
# daemon.yaml
security:
  enable_auth: true  # å¯ç”¨ PSK è®¤è¯
  psk: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"

  # å¯é€‰ï¼šé™åˆ¶åªå…è®¸ç‰¹å®š peer ID è¿æ¥ï¼ˆç™½åå•ï¼‰
  trusted_peers:
    - "12D3KooWBaiJyfJwTo4HCtGv3qBkZnMcuK3KvHmvW7SomeExamplePeerID1"
    - "12D3KooWBaiJyfJwTo4HCtGv3qBkZnMcuK3KvHmvW7SomeExamplePeerID2"
```

### PSK è®¤è¯åŸç†

1. **ç½‘ç»œéš”ç¦»** - ä½¿ç”¨ä¸åŒ PSK çš„èŠ‚ç‚¹æ— æ³•ç›¸äº’è¿æ¥
2. **æ¡æ‰‹éªŒè¯** - libp2p åœ¨è¿æ¥å»ºç«‹æ—¶éªŒè¯ PSK
3. **è¿æ¥æ‹’ç»** - PSK ä¸åŒ¹é…çš„è¿æ¥ä¼šè¢«ç«‹å³æ‹’ç»
4. **é€æ˜åŠ å¯†** - PSK è¿˜ç”¨äºå¢å¼ºä¼ è¾“åŠ å¯†å¼ºåº¦

### è¿æ¥ç™½åå•ï¼ˆå¯é€‰ï¼‰

é™¤äº† PSK è®¤è¯ï¼Œè¿˜å¯ä»¥é…ç½® `trusted_peers` ç™½åå•è¿›ä¸€æ­¥é™åˆ¶è¿æ¥ï¼š

```yaml
security:
  enable_auth: true
  psk: "..."
  trusted_peers:
    - "12D3KooW..."  # åªå…è®¸è¿™äº› peer ID è¿æ¥
```

**å·¥ä½œåŸç†**ï¼š
- å³ä½¿ PSK åŒ¹é…ï¼Œä¹Ÿåªå…è®¸ç™½åå•ä¸­çš„ peer ID è¿æ¥
- æä¾›åŒé‡ä¿æŠ¤ï¼ˆPSK + peer IDï¼‰
- é€‚åˆé«˜å®‰å…¨è¦æ±‚åœºæ™¯

**è·å– peer ID**ï¼š
```bash
# æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨åŠå…¶ peer ID
controller nodes

# è¾“å‡ºç¤ºä¾‹
Discovered 2 peer(s):
1. Peer ID: 12D3KooWBaiJyfJwTo4HCtGv3qBkZnMcuK3KvHmvW7Example1
   Addresses:
     - /ip4/192.168.1.100/tcp/9000

2. Peer ID: 12D3KooWBaiJyfJwTo4HCtGv3qBkZnMcuK3KvHmvW7Example2
   Addresses:
     - /ip4/192.168.1.101/tcp/9000
```

### PSK æœ€ä½³å®è·µ

#### å¼€å‘ç¯å¢ƒ
```yaml
security:
  enable_auth: true
  psk: "dev-environment-key-not-for-production-use-12345678901234567890ab"
  # ä¸è®¾ç½® trusted_peersï¼Œå¼€å‘èŠ‚ç‚¹å¯ä»¥è‡ªç”±åŠ å…¥
```

#### æµ‹è¯•ç¯å¢ƒ
```yaml
security:
  enable_auth: true
  psk: "test-environment-key-different-from-dev-567890abcdef1234567890ab"
  # å¯é€‰ï¼šé™åˆ¶æµ‹è¯•èŠ‚ç‚¹
  trusted_peers:
    - "12D3KooW..."  # æµ‹è¯•èŠ‚ç‚¹ 1
    - "12D3KooW..."  # æµ‹è¯•èŠ‚ç‚¹ 2
```

#### ç”Ÿäº§ç¯å¢ƒ
```yaml
security:
  enable_auth: true
  psk: "production-use-strong-random-psk-generated-by-controller-psk-cmd"
  # å¼ºçƒˆå»ºè®®ï¼šä½¿ç”¨ç™½åå•
  trusted_peers:
    - "12D3KooW..."  # ç”Ÿäº§èŠ‚ç‚¹ 1
    - "12D3KooW..."  # ç”Ÿäº§èŠ‚ç‚¹ 2
    - "12D3KooW..."  # ç”Ÿäº§èŠ‚ç‚¹ 3
  # å…¶ä»–å®‰å…¨é…ç½®
  allow_unsigned_packages: false  # æ‹’ç»æœªç­¾ååŒ…
```

### PSK ç®¡ç†å»ºè®®

1. **æ¯ä¸ªç¯å¢ƒä½¿ç”¨ä¸åŒçš„ PSK** - é¿å…ç¯å¢ƒé—´äº¤å‰æ±¡æŸ“
2. **å®šæœŸè½®æ¢ PSK** - å»ºè®®æ¯å­£åº¦æˆ–æ¯åŠå¹´è½®æ¢ä¸€æ¬¡
3. **å®‰å…¨å­˜å‚¨** - ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆVaultã€AWS KMS ç­‰ï¼‰å­˜å‚¨ PSK
4. **æœ€å°æƒé™** - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ PSK + trusted_peers åŒé‡ä¿æŠ¤
5. **å®¡è®¡æ—¥å¿—** - ç›‘æ§è¿æ¥æ‹’ç»æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸è®¿é—®å°è¯•

### æ•…éšœæ’æŸ¥

#### è¿æ¥å¤±è´¥ï¼šPSK ä¸åŒ¹é…

**ç—‡çŠ¶**ï¼šèŠ‚ç‚¹æ— æ³•ç›¸äº’å‘ç°æˆ–è¿æ¥

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
WARN  failed to connect to discovered peer  peer=12D3KooW...  error=failed to negotiate security protocol: protocol not supported
```

**è§£å†³æ–¹æ³•**ï¼š
1. ç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç›¸åŒçš„ PSK
2. æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ PSK æ ¼å¼ï¼ˆ64 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ï¼‰
3. ç¡®è®¤ `enable_auth: true` åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ç”¨

#### è¿æ¥è¢«ç™½åå•æ‹’ç»

**ç—‡çŠ¶**ï¼šPSK æ­£ç¡®ä½†ä»ç„¶æ— æ³•è¿æ¥

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
WARN  blocked connection from untrusted peer  peer=12D3KooW...
```

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `trusted_peers` åˆ—è¡¨
2. å°†ç›®æ ‡èŠ‚ç‚¹çš„ peer ID æ·»åŠ åˆ°ç™½åå•
3. é‡å¯ daemon ä½¿é…ç½®ç”Ÿæ•ˆ

## TLS 1.3 ä¼ è¾“åŠ å¯†

### æ¦‚è¿°

æ‰€æœ‰ P2P è¿æ¥é»˜è®¤ä½¿ç”¨ TLS 1.3 æˆ– Noise åè®®è¿›è¡Œç«¯åˆ°ç«¯åŠ å¯†ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

**ç‰¹æ€§**ï¼š
- âœ… **é»˜è®¤å¯ç”¨** - æ‰€æœ‰è¿æ¥è‡ªåŠ¨åŠ å¯†ï¼Œæ— éœ€é…ç½®
- âœ… **TLS 1.3** - ä½¿ç”¨æœ€æ–°çš„ TLS æ ‡å‡†
- âœ… **Noise åè®®** - è½»é‡çº§å¤‡é€‰åŠ å¯†åè®®
- âœ… **è‡ªåŠ¨åå•†** - libp2p è‡ªåŠ¨é€‰æ‹©æœ€ä½³åŠ å¯†æ–¹æ¡ˆ
- âœ… **å‰å‘ä¿å¯†** - æ”¯æŒ Forward Secrecy
- âœ… **èº«ä»½ç»‘å®š** - åŸºäº peer ID çš„èº«ä»½è®¤è¯

### å·¥ä½œåŸç†

libp2p åœ¨è¿æ¥å»ºç«‹æ—¶è‡ªåŠ¨è¿›è¡Œå®‰å…¨åå•†ï¼š

```
1. èŠ‚ç‚¹ A å‘èŠ‚ç‚¹ B å‘èµ·è¿æ¥
2. libp2p åå•†å®‰å…¨åè®®ï¼š
   - ä¼˜å…ˆå°è¯• TLS 1.3
   - å¦‚æœä¸æ”¯æŒï¼Œå›é€€åˆ° Noise åè®®
3. å»ºç«‹åŠ å¯†è¿æ¥
4. ç»‘å®š peer IDï¼ˆé˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼‰
5. å¼€å§‹åŠ å¯†é€šä¿¡
```

### PSK ä¸ TLS çš„å…³ç³»

PSK å’Œ TLS æ˜¯ä¸¤å±‚ç‹¬ç«‹çš„å®‰å…¨æœºåˆ¶ï¼š

| å±‚æ¬¡ | æœºåˆ¶ | ä½œç”¨ |
|------|------|------|
| **ç½‘ç»œå±‚** | PSK è®¤è¯ | æ§åˆ¶**è°èƒ½åŠ å…¥**ç½‘ç»œ |
| **ä¼ è¾“å±‚** | TLS 1.3 | ä¿æŠ¤**æ•°æ®ä¼ è¾“**çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ |

**å¯ä»¥ç»„åˆä½¿ç”¨**ï¼š
- âœ… åªç”¨ TLSï¼ˆé»˜è®¤ï¼‰ - æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½åŠ å…¥ï¼Œä½†æ•°æ®åŠ å¯†
- âœ… PSK + TLSï¼ˆæ¨èï¼‰ - åªæœ‰æˆæƒèŠ‚ç‚¹èƒ½åŠ å…¥ï¼Œä¸”æ•°æ®åŠ å¯†
- âŒ åªç”¨ PSKï¼ˆä¸æ¨èï¼‰ - libp2p ä»ä¼šä½¿ç”¨ TLSï¼Œæ— æ³•ç¦ç”¨

**é…ç½®ç¤ºä¾‹**ï¼ˆPSK + TLSï¼‰ï¼š
```yaml
security:
  enable_auth: true  # PSK ç½‘ç»œè®¤è¯
  psk: "..."         # é™åˆ¶è°èƒ½åŠ å…¥
  # TLS 1.3 è‡ªåŠ¨å¯ç”¨ï¼Œæ— éœ€é…ç½®
```

### éªŒè¯åŠ å¯†çŠ¶æ€

æŸ¥çœ‹ daemon å¯åŠ¨æ—¥å¿—ï¼š

```
INFO  libp2p host created  id=12D3KooW...  psk_enabled=true  trusted_peers=3
```

- `psk_enabled=true` - PSK è®¤è¯å·²å¯ç”¨
- TLS 1.3 - å§‹ç»ˆå¯ç”¨ï¼ˆlibp2p é»˜è®¤è¡Œä¸ºï¼‰

## Controller é…ç½®

### é…ç½®æ–‡ä»¶æ”¯æŒ

Controller æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†è®¾ç½®ï¼ˆç±»ä¼¼ kubectlï¼‰ï¼š

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶ (~/.p2p-playground/controller.yaml)
controller deploy app.tar.gz

# æŒ‡å®šé…ç½®æ–‡ä»¶
controller --config /path/to/config.yaml deploy app.tar.gz
controller -c prod-config.yaml nodes
```

### Controller é…ç½®ç¤ºä¾‹

```yaml
# ~/.p2p-playground/controller.yaml
node:
  listen_addrs:
    - /ip4/0.0.0.0/tcp/9001
  enable_mdns: true

logging:
  level: info      # debug|info|warn|error
  format: console  # console|json

storage:
  data_dir: ~/.p2p-playground-controller
  keys_dir: ~/.p2p-playground-controller/keys

security:
  # PSK ç½‘ç»œè®¤è¯ï¼ˆå¯é€‰ï¼‰
  enable_auth: true
  psk: "your-psk-here-generated-by-controller-psk-command"

  # åº”ç”¨åŒ…ç­¾åç­–ç•¥
  allow_unsigned_packages: false  # æ‹’ç»æœªç­¾ååŒ…ï¼ˆæ¨èï¼‰

deployment:
  timeout: 5m
  retry_attempts: 3
  retry_delay: 10s
```

**é…ç½®åŠ è½½é¡ºåº**ï¼š
1. å¦‚æœæŒ‡å®š `--config` å‚æ•°ï¼Œä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶
2. å¦åˆ™æ£€æŸ¥é»˜è®¤ä½ç½® `~/.p2p-playground/controller.yaml`
3. å¦‚æœé»˜è®¤æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼

## èŠ‚ç‚¹é…ç½®

### é…ç½®å¯ä¿¡å…¬é’¥

åœ¨ daemon èŠ‚ç‚¹ä¸Šé…ç½®å¯ä¿¡çš„å…¬é’¥ï¼š

1. åˆ›å»ºå¯ä¿¡å…¬é’¥ç›®å½•ï¼š
```bash
mkdir -p ~/.p2p-playground/keys/trusted
```

2. å°† controller çš„å…¬é’¥å¤åˆ¶åˆ°è¯¥ç›®å½•ï¼š
```bash
cp controller.pub ~/.p2p-playground/keys/trusted/
```

daemon ä¼šè‡ªåŠ¨åŠ è½½è¯¥ç›®å½•ä¸‹æ‰€æœ‰ `.pub` æ–‡ä»¶ä½œä¸ºå¯ä¿¡å…¬é’¥ã€‚

### é…ç½®ç­¾åéªŒè¯ç­–ç•¥

åœ¨ daemon é…ç½®æ–‡ä»¶ä¸­è®¾ç½®å®‰å…¨é€‰é¡¹ï¼š

```yaml
# daemon.yaml
security:
  # PSK ç½‘ç»œè®¤è¯ï¼ˆå¯é€‰ï¼‰
  enable_auth: true
  psk: "your-psk-here-same-as-controller"

  # å¯ä¿¡èŠ‚ç‚¹ç™½åå•ï¼ˆå¯é€‰ï¼Œä¸ PSK é…åˆä½¿ç”¨ï¼‰
  trusted_peers:
    - "12D3KooW..."  # å…è®¸è¿æ¥çš„ peer ID

  # åº”ç”¨åŒ…ç­¾åéªŒè¯ç­–ç•¥
  # æ˜¯å¦å…è®¸éƒ¨ç½²æœªç­¾åçš„åº”ç”¨åŒ…
  allow_unsigned_packages: false  # âš ï¸ é»˜è®¤ falseï¼ˆæ‹’ç»æœªç­¾ååŒ…ï¼‰

  # å¯ä¿¡å…¬é’¥ç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º keys/trustedï¼‰
  public_keys_dir: ~/.p2p-playground/keys/trusted
```

**é…ç½®é€‰é¡¹è¯´æ˜**ï¼š

- `allow_unsigned_packages: false` (**é»˜è®¤å€¼ï¼Œæ¨è**)
  - å¿…é¡»æœ‰ç­¾åæ‰èƒ½éƒ¨ç½²
  - ç­¾åéªŒè¯å¤±è´¥ä¼šæ‹’ç»éƒ¨ç½²
  - æœªç­¾åçš„åŒ…ä¼šè¢«æ‹’ç»
  - é€‚åˆç”Ÿäº§ç¯å¢ƒå’Œå®‰å…¨æ•æ„Ÿåœºæ™¯
  - **è¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ›´å®‰å…¨**

- `allow_unsigned_packages: true` (å¼€å‘/æµ‹è¯•ç¯å¢ƒ)
  - å¦‚æœæœ‰ç­¾åï¼Œä¼šè¿›è¡ŒéªŒè¯
  - å¦‚æœæ²¡æœ‰ç­¾åï¼Œä¼šè®°å½• warning ä½†ä»ç„¶å…è®¸éƒ¨ç½²
  - é€‚åˆæœ¬åœ°å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
  - **éœ€è¦æ˜¾å¼é…ç½®æ‰èƒ½å…è®¸æœªç­¾ååŒ…**

## ç­¾åéªŒè¯æµç¨‹

å½“ daemon æ”¶åˆ°éƒ¨ç½²è¯·æ±‚æ—¶ï¼š

1. **æ£€æŸ¥ç­¾åæ˜¯å¦å­˜åœ¨**
   - å¦‚æœæœ‰ç­¾å â†’ è¿›å…¥éªŒè¯æµç¨‹
   - å¦‚æœæ²¡æœ‰ç­¾åï¼š
     - å¦‚æœ `allow_unsigned_packages: false`ï¼ˆé»˜è®¤ï¼‰ â†’ æ‹’ç»éƒ¨ç½²
     - å¦‚æœ `allow_unsigned_packages: true` â†’ è®°å½• warningï¼Œå…è®¸éƒ¨ç½²

2. **ç­¾åéªŒè¯**ï¼ˆå¦‚æœæœ‰ç­¾åï¼‰
   - è®¡ç®—åº”ç”¨åŒ…çš„ SHA-256 å“ˆå¸Œ
   - ä½¿ç”¨å¯ä¿¡å…¬é’¥ç›®å½•ä¸­çš„æ‰€æœ‰å…¬é’¥å°è¯•éªŒè¯
   - ä»»ä½•ä¸€ä¸ªå…¬é’¥éªŒè¯æˆåŠŸ â†’ éªŒè¯é€šè¿‡
   - æ‰€æœ‰å…¬é’¥éƒ½éªŒè¯å¤±è´¥ â†’ æ‹’ç»éƒ¨ç½²

3. **éªŒè¯ç»“æœ**
   - éªŒè¯é€šè¿‡ â†’ ç»§ç»­éƒ¨ç½²æµç¨‹
   - éªŒè¯å¤±è´¥ â†’ æ‹’ç»éƒ¨ç½²ï¼Œè¿”å›é”™è¯¯

## æ—¥å¿—ç¤ºä¾‹

### Controller æ—¥å¿—

```
# æœ‰ç­¾åçš„éƒ¨ç½²
2026-01-19T10:00:00Z  info  package signature found  sig_path=/path/to/package.tar.gz.sig
2026-01-19T10:00:01Z  info  sending package  file=package.tar.gz  size=1425653

# æ— ç­¾åçš„éƒ¨ç½²
2026-01-19T10:00:00Z  warn  no package signature found, deploying without signature verification
```

### Daemon æ—¥å¿—

```
# ç­¾åéªŒè¯æˆåŠŸ
2026-01-19T10:00:02Z  info  verifying package signature
2026-01-19T10:00:02Z  info  signature verified  public_key=controller.pub
2026-01-19T10:00:02Z  info  package deployed  app_id=myapp-1.0.0

# ç­¾åéªŒè¯å¤±è´¥
2026-01-19T10:00:02Z  info  verifying package signature
2026-01-19T10:00:02Z  error  signature verification failed  error=invalid signature
# éƒ¨ç½²è¢«æ‹’ç»

# æ— ç­¾åä½†ä¸å¼ºåˆ¶
2026-01-19T10:00:02Z  warn  package deployed without signature verification
```

## æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ

1. ç”Ÿæˆæµ‹è¯•å¯†é’¥å¯¹
2. ç­¾ååº”ç”¨åŒ…ï¼ˆå¯é€‰ï¼‰
3. é…ç½® `allow_unsigned_packages: true` ï¼ˆå…è®¸æœªç­¾ååŒ…ï¼Œä¾¿äºå¼€å‘ï¼‰
4. è§‚å¯Ÿæ—¥å¿—ç¡®è®¤ç­¾åæœºåˆ¶å·¥ä½œæ­£å¸¸

### ç”Ÿäº§ç¯å¢ƒ

1. ç”Ÿæˆæ­£å¼å¯†é’¥å¯¹ï¼Œå¦¥å–„ä¿ç®¡ç§é’¥
2. å°†å…¬é’¥åˆ†å‘åˆ°æ‰€æœ‰ç”Ÿäº§èŠ‚ç‚¹
3. æ‰€æœ‰åº”ç”¨åŒ…å¿…é¡»ç­¾å
4. ä¿æŒ `allow_unsigned_packages: false`ï¼ˆé»˜è®¤ï¼Œæ‹’ç»æœªç­¾ååŒ…ï¼‰
5. å®šæœŸè½®æ¢å¯†é’¥å¯¹

### å¯†é’¥ç®¡ç†

- ç§é’¥æƒé™è®¾ç½®ä¸º `0600`ï¼ˆä»…æ‰€æœ‰è€…å¯è¯»å†™ï¼‰
- å®šæœŸå¤‡ä»½ç§é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
- ä½¿ç”¨ HSM æˆ–å¯†é’¥ç®¡ç†æœåŠ¡å­˜å‚¨ç§é’¥ï¼ˆå¯é€‰ï¼‰
- æ¯ä¸ªç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥å¯¹
- å®šæœŸè½®æ¢å¯†é’¥ï¼ˆå»ºè®®æ¯å¹´ä¸€æ¬¡ï¼‰

### å¤šå…¬é’¥æ”¯æŒ

daemon æ”¯æŒåŒæ—¶ä¿¡ä»»å¤šä¸ªå…¬é’¥ï¼Œè¿™åœ¨ä»¥ä¸‹åœºæ™¯å¾ˆæœ‰ç”¨ï¼š

1. **å¯†é’¥è½®æ¢æœŸé—´** - åŒæ—¶ä¿¡ä»»æ—§å¯†é’¥å’Œæ–°å¯†é’¥
2. **å¤šå›¢é˜Ÿå‘å¸ƒ** - æ¯ä¸ªå›¢é˜Ÿæœ‰è‡ªå·±çš„å¯†é’¥å¯¹
3. **å¤šç¯å¢ƒ** - ä¸åŒç¯å¢ƒçš„åŒ…å¯ä»¥ç”¨ä¸åŒå¯†é’¥ç­¾å

åªéœ€å°†å¤šä¸ª `.pub` æ–‡ä»¶æ”¾åˆ° `keys/trusted/` ç›®å½•å³å¯ã€‚

## å®‰å…¨å†³ç­–è®°å½•

### Phase 2.1 å®ç°å†³ç­–

**å†³ç­–** (âš ï¸ å·²æ›´æ–°)ï¼šç­¾åéªŒè¯é»˜è®¤å¼ºåˆ¶ï¼ˆ`allow_unsigned_packages: false`ï¼‰

**ç†ç”±**ï¼š
1. **å®‰å…¨ä¼˜å…ˆ** - é»˜è®¤æ‹’ç»æœªç­¾ååŒ…ï¼Œé˜²æ­¢æœªæˆæƒä»£ç æ‰§è¡Œ
2. **æ¸…æ™°çš„å®‰å…¨å§¿æ€** - ç”¨æˆ·å¿…é¡»æ˜¾å¼é€‰æ‹©å…è®¸æœªç­¾ååŒ…
3. **ç¬¦åˆè¡Œä¸šæœ€ä½³å®è·µ** - ä¸å®¹å™¨ç­¾åã€ä»£ç ç­¾åæ ‡å‡†ä¸€è‡´
4. **æ›´å¥½çš„é…ç½®åç§°** - `allow_unsigned_packages` è¯­ä¹‰æ›´æ¸…æ™°ï¼ˆfalse = æ›´å®‰å…¨ï¼‰

**é…ç½®è¿ç§»**ï¼š
- æ—§ç‰ˆæœ¬ä½¿ç”¨ `require_signed_packages: true/false`
- æ–°ç‰ˆæœ¬ä½¿ç”¨ `allow_unsigned_packages: true/false`
- é€»è¾‘åè½¬ï¼š`require_signed: true` = `allow_unsigned: false`

**æœªæ¥è®¡åˆ’**ï¼š
- Phase 3ï¼šæ·»åŠ æ›´ç»†ç²’åº¦çš„ç­–ç•¥ï¼ˆæŒ‰åº”ç”¨ã€æŒ‰èŠ‚ç‚¹æ ‡ç­¾ç­‰ï¼‰
- Phase 3ï¼šå¯†é’¥æ’¤é”€å’Œè½®æ¢è‡ªåŠ¨åŒ–

### ç­¾åç®—æ³•é€‰æ‹©

**é€‰æ‹©**ï¼šEd25519

**ç†ç”±**ï¼š
- æ€§èƒ½ä¼˜ç§€ï¼ˆç­¾åå’ŒéªŒè¯éƒ½å¾ˆå¿«ï¼‰
- å¯†é’¥å°ºå¯¸å°ï¼ˆ32å­—èŠ‚å…¬é’¥ï¼Œ64å­—èŠ‚ç§é’¥ï¼‰
- å®‰å…¨æ€§é«˜ï¼ˆ128ä½å®‰å…¨çº§åˆ«ï¼‰
- Go æ ‡å‡†åº“åŸç”Ÿæ”¯æŒ
- ç°ä»£å¯†ç å­¦æ ‡å‡†

## æ•…éšœæ’æŸ¥

### ç­¾åéªŒè¯å¤±è´¥

**é”™è¯¯**ï¼š`signature verification failed: invalid signature`

**å¯èƒ½åŸå› **ï¼š
1. ç­¾åæ–‡ä»¶æŸå
2. åº”ç”¨åŒ…è¢«ç¯¡æ”¹
3. ä½¿ç”¨äº†é”™è¯¯çš„å…¬é’¥
4. å…¬é’¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•**ï¼š
1. é‡æ–°ç­¾ååº”ç”¨åŒ…
2. ç¡®è®¤å…¬é’¥æ­£ç¡®å¤åˆ¶åˆ° daemon
3. æ£€æŸ¥å…¬é’¥æ–‡ä»¶æƒé™å’Œæ ¼å¼
4. æŸ¥çœ‹ daemon æ—¥å¿—ç¡®è®¤åŠ è½½äº†å“ªäº›å…¬é’¥

### æ²¡æœ‰å¯ä¿¡å…¬é’¥

**é”™è¯¯**ï¼š`no trusted public keys found in /path/to/keys/trusted`

**è§£å†³æ–¹æ³•**ï¼š
1. åˆ›å»º `keys/trusted` ç›®å½•
2. å¤åˆ¶å…¬é’¥æ–‡ä»¶åˆ°è¯¥ç›®å½•
3. ç¡®ä¿å…¬é’¥æ–‡ä»¶æ‰©å±•åä¸º `.pub`
4. é‡å¯ daemon

### æ‰¾ä¸åˆ°ç­¾åæ–‡ä»¶

**è­¦å‘Š**ï¼š`no package signature found, deploying without signature verification`

**è¯´æ˜**ï¼šè¿™ä¸æ˜¯é”™è¯¯ï¼Œåªæ˜¯æç¤ºæ²¡æœ‰æ‰¾åˆ°ç­¾åæ–‡ä»¶ã€‚

**è§£å†³æ–¹æ³•**ï¼ˆå¦‚æœéœ€è¦ç­¾åï¼‰ï¼š
1. ä½¿ç”¨ `controller sign` å¯¹åŒ…è¿›è¡Œç­¾å
2. ç¡®ä¿ `.sig` æ–‡ä»¶å’ŒåŒ…æ–‡ä»¶åœ¨åŒä¸€ç›®å½•
3. é‡æ–°éƒ¨ç½²

## æœªæ¥å¢å¼º

ä»¥ä¸‹åŠŸèƒ½è®¡åˆ’åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°ï¼š

1. **è¯ä¹¦è®¤è¯** - æ”¯æŒ X.509 è¯ä¹¦è¿›è¡ŒèŠ‚ç‚¹è®¤è¯ï¼ˆæ›¿ä»£æˆ–è¡¥å…… PSKï¼‰
2. **ç­¾åæ—¶é—´æˆ³** - è®°å½•ç­¾åæ—¶é—´ï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»
3. **æ’¤é”€åˆ—è¡¨** - æ”¯æŒæ’¤é”€å·²æ³„éœ²çš„å¯†é’¥
4. **ç»†ç²’åº¦ç­–ç•¥** - æŒ‰åº”ç”¨ã€æ ‡ç­¾ç­‰ç»´åº¦é…ç½®ä¸åŒçš„å®‰å…¨ç­–ç•¥
5. **å®¡è®¡æ—¥å¿—** - å®Œæ•´çš„å®‰å…¨äº‹ä»¶å®¡è®¡è¿½è¸ª
